\PassOptionsToPackage{x11names}{xcolor}
\documentclass{beamer}

\beamertemplatenavigationsymbolsempty

\usepackage{tikz}
\usetikzlibrary{shapes.geometric}

\usepackage{listings}

\lstset{ %
  language=C,
  numbers=left,
  numberstyle=\tiny,
  stepnumber=1,
  numbersep=5pt,
  breaklines=true,
}

\usepackage{idris2}
\usepackage{catchfilebetweentags}
\input{robust-catch}

\newcommand{\hexadesc}[1]{\texttt{\IdrisType{#1}}}
\newcommand{\hexadata}[1]{\texttt{\IdrisData{#1}}}
\newcommand{\hexacons}[1]{\texttt{\IdrisFunction{#1}}}
\newcommand{\hexaoffset}[1]{\texttt{{\color{lightgray}#1}}}

\newenvironment{hexdump}{\medskip\ttfamily\obeyspaces\obeylines\noindent}{\medskip}

\title{
  \[
  \left.
    \begin{tabular}{l}
      Seamless \\
      Correct \\
      Generic
    \end{tabular}
  \right\}
  \text{Programming over Serialised Data}
  \]}
\author{Guillaume Allais}
\institute{University of St Andrews}
\date{SPLS, March 8th 2023}

\AtBeginSection[]
{
    \begin{frame}
        \frametitle{Table of Contents}
        \tableofcontents[currentsection]
    \end{frame}
}

\begin{document}

\begin{frame}
  \maketitle
\end{frame}

\section{Motivation}

\newcommand{\mknode}[3]{\draw (#1,#2)  circle (.27cm) node[align=center] {\IdrisData{#3}};}
\newcommand{\mkleaf}[2]{\draw[fill=black] (#1,#2) node[align=center] {} +(-.1cm,-.1cm) rectangle +(.1cm,.1cm);}

\begin{frame}{Trees and Pattern Matching}
\begin{minipage}{.5\textwidth}
\begin{tikzpicture}
\mknode{0}{0}{10}
  \mknode{-1}{-1}{5};
    \mknode{-2}{-2}{1};
      \mkleaf{-2.7}{-3};
      \mkleaf{-1.3}{-3};
  \mkleaf{-.2}{-2}
  \mknode{1}{-1}{20}
    \mkleaf{.2}{-2}
    \mkleaf{1.8}{-2}

\draw [->] (-0.27,0) to [out=180,in=90] (-1,-.73);
  \draw [->] (-1.27,-1) to [out=180,in=90] (-2,-1.73);
    \draw [->] (-2.27,-2) to [out=180,in=90] (-2.7,-2.9);
    \draw [->] (-1.73,-2) to [out=0,in=90] (-1.3,-2.9);
  \draw [->] (-.73,-1) to [out=0,in=90] (-.2,-1.9);
\draw [->] (0.27,0) to [out=0,in=90] (1,-.73);
  \draw [->] (.73,-1) to [out=180,in=90] (.2,-1.9);
  \draw [->] (1.27,-1) to [out=0,in=90] (1.8,-1.9);
\end{tikzpicture}
\end{minipage}\hfill
\begin{minipage}{.45\textwidth}
  \ExecuteMetaData[Motivating.idr.tex]{motivation}
\end{minipage}
\end{frame}

\begin{frame}[fragile]{Serialised Data and Pointer Manipulations}
\begin{hexdump}
01 01 01 00 \hexadata{01} 00 \hexadata{05} 00 \hexadata{0a} 01 00 \hexadata{14} 00
\end{hexdump}
\begin{overlayarea}{\linewidth}{6cm}
\begin{onlyenv}<2->
\begin{lstlisting}
int sumAt (int buf[], int *ptr, int *res) {
  int tag = buf[*ptr]; (*ptr)++;
  switch (tag) {
    case 0: return 0;
    case 1:
      sumAt(buf, ptr, res);
      int val = buf[*ptr]; (*ptr)++;
      *res += val;
      sumAt(buf, ptr, res);
      return 0;
    default: exit(-1); }}
\end{lstlisting}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\begin{frame}{Seamless}

  \vspace*{2em}

  \begin{minipage}{.6\textwidth}
    \hspace*{-1em}\ExecuteMetaData[SaferIndexed.idr.tex]{tsum}
  \end{minipage}\hfill

  \hfill\begin{minipage}{.6\textwidth}
    \hspace*{-1em}\ExecuteMetaData[SaferIndexed.idr.tex]{rsum}
  \end{minipage}
\end{frame}


\begin{frame}{Correct}
  \ExecuteMetaData[Data/Singleton.idr.tex]{singleton}
  \vfill
  \hspace{-1em}\ExecuteMetaData[SaferIndexed.idr.tex]{csum}
\end{frame}


\begin{frame}{Generic}
  \ExecuteMetaData[Serialised/Desc.idr.tex]{data}

  \vspace*{2em}

  \hspace{-2em}\ExecuteMetaData[SaferIndexed.idr.tex]{viewfun}
\end{frame}

\section{The Universe}

\begin{frame}{Descriptions}
  \ExecuteMetaData[Serialised/Desc.idr.tex]{desctype}

  \uncover<2->{\ExecuteMetaData[Serialised/Desc.idr.tex]{desc}}
\end{frame}

\begin{frame}{Meaning as Strictly Positive Functors}
  \ExecuteMetaData[Lib.idr.tex]{pair}
  \vfill
  \hspace*{-1em}\ExecuteMetaData[Serialised/Desc.idr.tex]{meaning}
\end{frame}

\begin{frame}{Constructor descriptions}
  \ExecuteMetaData[Serialised/Desc.idr.tex]{constructor}

  \vfill

  \hspace*{-1em}\ExecuteMetaData[Serialised/Desc.idr.tex]{treeleaf}
  \hspace*{-1em}\ExecuteMetaData[Serialised/Desc.idr.tex]{treenode}
\end{frame}

\begin{frame}{Data descriptions}
  \ExecuteMetaData[Serialised/Desc.idr.tex]{data}

  \vfill

  \hspace*{-1em}\ExecuteMetaData[Serialised/Desc.idr.tex]{treedesc}
\end{frame}

\begin{frame}{Meaning as Trees}
  \hspace*{-1em}\ExecuteMetaData[Serialised/Desc.idr.tex]{index}

  \hspace*{-2em}\ExecuteMetaData[Serialised/Desc.idr.tex]{alg}

  \hspace*{-2em}\ExecuteMetaData[Serialised/Desc.idr.tex]{mu}
\end{frame}

\begin{frame}{Example}
\hspace*{-1em}\ExecuteMetaData[Serialised/Desc.idr.tex]{leaf}
\hspace*{-1em}\ExecuteMetaData[Serialised/Desc.idr.tex]{node}

\hspace*{-1em}\ExecuteMetaData[Serialised/Desc.idr.tex]{example}
\end{frame}

\section{Programming with Buffers}

\begin{frame}{Serialisation Format}
\hspace*{-1em}\ExecuteMetaData[Serialised/Desc.idr.tex]{example}

\begin{hexdump}%
87654321\hphantom{:} 00 11 22 33 44 55 66 77 88 99 AA BB CC DD EE FF
00000000: \hexaoffset{07 00 00 00 00 00 00 00} \hexadesc{02 00 02 03 02 01 03} \hexacons{01}
00000010: \hexaoffset{17 00 00 00 00 00 00 00} \hexacons{01} \hexaoffset{0c 00 00 00 00 00 00}
00000020: \hexaoffset{00} \hexacons{01} \hexaoffset{01 00 00 00 00 00 00 00} \hexacons{00} \hexadata{01} \hexacons{00} \hexadata{05} \hexacons{00} \hexadata{0a}
00000030: \hexacons{01} \hexaoffset{01 00 00 00 00 00 00 00} \hexacons{00} \hexadata{14} \hexacons{00}
\end{hexdump}
\end{frame}

\begin{frame}{Meaning as Pointers}
  \hspace*{-2em}\ExecuteMetaData[SaferIndexed.idr.tex]{elem}

  \hspace*{-2em}\ExecuteMetaData[SaferIndexed.idr.tex]{pointermu}
\end{frame}

\begin{frame}{Inspecting Buffers: Head Constructor}
  \hspace*{-2em}\ExecuteMetaData[SaferIndexed.idr.tex]{outdata}
  \hspace*{-2em}\ExecuteMetaData[SaferIndexed.idr.tex]{outfun}
\end{frame}

\begin{frame}{Inspecting Buffers: Extracting Head Data}
  \hspace*{-2em}\ExecuteMetaData[SaferIndexed.idr.tex]{pokedata}
\end{frame}
\begin{frame}{Inspecting Buffers: Extracting Head Data (ct'd)}
  \hspace*{-2em}\ExecuteMetaData[SaferIndexed.idr.tex]{pokefun}
\end{frame}

\begin{frame}{A More Convenient View}
  \hspace*{-3em}\ExecuteMetaData[SaferIndexed.idr.tex]{viewdata}
  \hspace*{-3em}\ExecuteMetaData[SaferIndexed.idr.tex]{viewfun}
\end{frame}

\section{Future work}

\end{document}
